<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>thread-again | Merlin&#39;s Blog</title>
  <meta name="author" content="MerlinYu">
  
  <meta name="description" content="techniques of thread in c++">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="thread-again"/>
  <meta property="og:site_name" content="Merlin&#39;s Blog"/>

  
    <meta property="og:image" content="undefined"/>
  

  
  
    <link href="/favicon.png" rel="ico">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  



</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">Merlin&#39;s Blog</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="Subscribe me.">
			  <i class=""></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">
			<h1> thread-again</h1>
		</div>
	



<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  
		 <div class="alert alert-success description">
			<i class="fa fa-info-circle"></i> techniques of thread in c++
		 </div> <!-- alert -->
	  		

	  <p>如果不看 Futures 库, 整个 C++ 并发库, 就跟 pthread 没有啥区别. 如果加上Futures库, 整个和Boost又没有太多差别. 总之, 整个C++并发库貌似都是在炒冷饭的样子, 不是移植boost, 就是封装底层线程库(例如pthread), 没办法还是仔细说说吧.</p>
<p>关于Pthread, 可以参考我的博文:  <a href="http://www.merlinblog.site/2017/03/19/linux-pthread.html" target="_blank" rel="external">posix-thread</a><br>关于Boost, 可以参考我的博文: <a href="http://www.merlinblog.site/2017/06/21/boost.html" target="_blank" rel="external">Boost总结</a></p>
<blockquote>
<p>本文会花非常大的力气总结C++11并发库</p>
</blockquote>
<a id="more"></a>
<h1 id="引子"><a href="#引子" class="headerlink" title="引子"></a>引子</h1><p>C+11中的实现基本和Boost一致, 只不过命名空间不一样以及涉及的头文件不一样:</p>
<ul>
<li>atomic</li>
<li>mutex</li>
<li>thread</li>
<li>condition_variable</li>
<li>future</li>
</ul>
<p>并且相关效率也不一样, 一般认为: lock, atomic, spinlock三者的效率相当, 但是mutex效率低. (这也是你看到为啥和libevent相比, 不管是asio还是多线程框架, 基本讨不到偏移, 可能就是因为mutex的关系).</p>
<p><code>《C++ Concurrency In Action》</code> 真本书非常推荐, 如果没有时间看完一本书, 那么直接看我说精华, 也不错.</p>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>首先c++, 或者boost 为了我们方便的使用线程, 做了很多封装, 什么gud之类的, 反而影响了我们对于线程范畴内最本质内容的理解:</p>
<ul>
<li>线程的控制(创建，销毁/分离)</li>
<li>线程的同步(信号量(PV)，互斥量，竞争/冒险条件，文件锁，屏障)</li>
<li>线程的属性</li>
<li>线程的调试(多线程其实是不好调试的)</li>
</ul>
<hr>
<p>根据 <a href="http://en.cppreference.com/w/cpp/thread" target="_blank" rel="external">Cppreference</a> 的说法, C++11并发库包含以下内容:</p>
<ul>
<li>atomic<br>该头文主要声明了两个类, std::atomic 和 std::atomic_flag，另外还声明了一套 C 风格的原子类型和与 C 兼容的原子操作的函数.<br>这个和boost是一致的, 不适用锁就能同步的原子操作</li>
<li>thread<br>该头文件主要声明了 std::thread 类, 另外 <code>std::this_thread</code> 命名空间也在该头文件中.</li>
<li>mutex<br>该头文件主要声明了与互斥量(mutex)相关的类，包括 std::mutex 系列类，std::lock_guard, std::unique_lock, 以及其他的类型和函数</li>
<li>condition_variable<br>该头文件主要声明了与条件变量相关的类，包括 std::condition_variable 和 std::condition_variable_any</li>
<li>future<br>该头文件主要声明了 <code>std::promise</code>, <code>std::package_task</code> 两个 Provider 类，以及 <code>std::future</code> 和 <code>std::shared_future</code> 两个 Future 类<br>另外还有一些与之相关的类型和函数，<code>std::async()</code> 函数就声明在此头文件中</li>
</ul>
<p>其中最后一个future由于涉及到了异步任务, 相当于对于线程的封装. 异步任务可以参考我的文章 <a href="http://www.merlinblog.site/2017/08/11/Asio.html" target="_blank" rel="external">Asio</a></p>
<p>讲真, 从pthread切换过来, 没有感觉到幸福可能是因为pthread api用熟悉了, 但是不得不说c++并发库, 使得并发编程变得简单了.</p>
<p>直接上手一个demo:<br><img src="http://omotkhw3y.bkt.clouddn.com/cpp_thread.jpg" alt=""></p>
<p>可以看到老奸巨猾的c++11, 还是只给出了标准, 具体的实现, 要依赖系统平台的库.</p>
<p>也就是说, linux平台, 我们完全可以认为, c++ 并发库给出了统一的操作API, 实际上是封装了pthread操作(具体封装过程可以参考具体的头文件, 比如创建线程这个, 其实就是根据_type参数判断对应pthread_create()的哪种调用).</p>
<p>虽然只是封装, 但是, 确实精简了太多! 例如我要给线程执行函数传参, 看看下面是不是够简单的:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> n1 = <span class="number">500</span>;</div><div class="line">    <span class="keyword">int</span> n2 = <span class="number">600</span>;</div><div class="line">    <span class="built_in">std</span>::<span class="function">thread <span class="title">t</span><span class="params">([&amp;](<span class="keyword">int</span> addNum)</span></span>&#123;</div><div class="line">        n1 += addNum;</div><div class="line">        n2 += addNum;</div><div class="line">    &#125;,<span class="number">500</span>);</div><div class="line">    t.join();</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; n1 &lt;&lt; <span class="string">' '</span> &lt;&lt; n2 &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下面开始细说</p>
<hr>
<h2 id="Threads库"><a href="#Threads库" class="headerlink" title="Threads库"></a>Threads库</h2><p>定义在 <code>thread</code> 头文件下, 该库就两大块儿</p>
<ul>
<li>thread类</li>
<li>this_thread命名空间</li>
</ul>
<h3 id="thread类"><a href="#thread类" class="headerlink" title="thread类"></a>thread类</h3><p>主要说说他的构造器, 赋值函数(移动函数)等成员函数的使用.</p>
<p>构造器:</p>
<ul>
<li><p>默认构造函数，创建一个空的 thread 执行对象</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">thread() <span class="keyword">noexcept</span>;</div></pre></td></tr></table></figure>
</li>
<li><p>初始化构造函数，创建一个 thread对象，该 thread对象可被 joinable，新产生的线程会调用 fn 函数，该函数的参数由 args 给出</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> Fn, <span class="keyword">class</span>... Args&gt;</div><div class="line"><span class="function"><span class="keyword">explicit</span> <span class="title">thread</span> <span class="params">(Fn&amp;&amp; fn, Args&amp;&amp;... args)</span></span>;</div></pre></td></tr></table></figure>
</li>
<li><p>拷贝构造函数(被禁用)，意味着 thread 不可被拷贝构造</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">thread (<span class="keyword">const</span> thread&amp;) = <span class="keyword">delete</span>;</div></pre></td></tr></table></figure>
</li>
<li><p>move 构造函数，move 构造函数，调用成功之后 x 不代表任何 thread 执行对象</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">thread (thread&amp;&amp; x) <span class="keyword">noexcept</span>;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>参考代码:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">#include &lt;iostream&gt;</div><div class="line">#include &lt;thread&gt;</div><div class="line">#include &lt;functional&gt;</div><div class="line"> </div><div class="line">void f1(int n)</div><div class="line">&#123;</div><div class="line">    for (int i = 0; i &lt; 5; ++i) &#123;</div><div class="line">        std::cout &lt;&lt; "Thread " &lt;&lt; n &lt;&lt; " executing\n";</div><div class="line">        std::this_thread::sleep_for(std::chrono::milliseconds(10));</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"> </div><div class="line">void f2(int&amp; n)</div><div class="line">&#123;</div><div class="line">    for (int i = 0; i &lt; 5; ++i) &#123;</div><div class="line">        std::cout &lt;&lt; "Thread 2 executing\n";</div><div class="line">        ++n;</div><div class="line">        std::this_thread::sleep_for(std::chrono::milliseconds(10));</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"> </div><div class="line">int main()</div><div class="line">&#123;</div><div class="line">    int n = 0;</div><div class="line">    std::thread t1; // t1 is not a thread</div><div class="line">    std::thread t2(f1, n + 1); // pass by value</div><div class="line">    std::thread t3(f2, std::ref(n)); // pass by reference</div><div class="line">    std::thread t4(std::move(t3)); // t4 is now running f2(). t3 is no longer a thread</div><div class="line">    t2.join();</div><div class="line">    t4.join();</div><div class="line">    std::cout &lt;&lt; "Final value of n is " &lt;&lt; n &lt;&lt; '\n';</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>移动赋值函数</p>
<ul>
<li><p>move 赋值操作，如果当前对象不可 joinable，传递一个右值引用(rhs)给 move 赋值操作；如果当前对象可被 joinable，则调用 terminate() .</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">thread&amp; <span class="keyword">operator</span>= (thread&amp;&amp; rhs) <span class="keyword">noexcept</span>;</div></pre></td></tr></table></figure>
</li>
<li><p>拷贝赋值操作被禁用，thread 对象不可被拷贝</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">thread&amp; <span class="keyword">operator</span>= (<span class="keyword">const</span> thread&amp;) = <span class="keyword">delete</span>;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>其他成员函数:</p>
<ul>
<li><p>bool joinable() const noexcept; 检查某个线程是否可以被joinable (正在运行的可以被joinable)<br>代码:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;chrono&gt;</span></span></div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="built_in">std</span>::this_thread::sleep_for(<span class="built_in">std</span>::chrono::seconds(<span class="number">1</span>));</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="built_in">std</span>::thread t;</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"before starting, joinable: "</span> &lt;&lt; t.joinable() &lt;&lt; <span class="string">'\n'</span>;</div><div class="line"> </div><div class="line">    t = <span class="built_in">std</span>::thread(foo);</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"after starting, joinable: "</span> &lt;&lt; t.joinable() &lt;&lt; <span class="string">'\n'</span>;</div><div class="line"> </div><div class="line">    t.join();</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"after joining, joinable: "</span> &lt;&lt; t.joinable() &lt;&lt; <span class="string">'\n'</span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">/* 运行结果:</span></div><div class="line">before starting, joinable: 0</div><div class="line">after starting, joinable: 1</div><div class="line">after joining, joinable: 0</div><div class="line">*/</div></pre></td></tr></table></figure>
<p><code>最好把joinable理解成正在运行</code> , 后面说成员数join的时候, 还会用到.</p>
</li>
<li>std::thread::id get_id() const noexcept; 获取线程id</li>
<li><p>native_handle_type native_handle(); 返回一个线程handler, 用于实时调度<br>由于系统对于实时调度的支持不同, 所以下面的代码不一定成功.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">#include &lt;thread&gt;</div><div class="line">#include &lt;mutex&gt;</div><div class="line">#include &lt;iostream&gt;</div><div class="line">#include &lt;chrono&gt;</div><div class="line">#include &lt;cstring&gt;</div><div class="line">#include &lt;pthread.h&gt;</div><div class="line"> </div><div class="line">std::mutex iomutex;</div><div class="line">void f(int num)</div><div class="line">&#123;</div><div class="line">    std::this_thread::sleep_for(std::chrono::seconds(1));</div><div class="line"> </div><div class="line">    sched_param sch;</div><div class="line">    int policy; </div><div class="line">    pthread_getschedparam(pthread_self(), &amp;policy, &amp;sch);</div><div class="line">    std::lock_guard&lt;std::mutex&gt; lk(iomutex);</div><div class="line">    std::cout &lt;&lt; "Thread " &lt;&lt; num &lt;&lt; " is executing at priority "</div><div class="line">              &lt;&lt; sch.sched_priority &lt;&lt; '\n';</div><div class="line">&#125;</div><div class="line"> </div><div class="line">int main()</div><div class="line">&#123;</div><div class="line">    std::thread t1(f, 1), t2(f, 2);</div><div class="line"> </div><div class="line">    sched_param sch;</div><div class="line">    int policy; </div><div class="line">    pthread_getschedparam(t1.native_handle(), &amp;policy, &amp;sch);</div><div class="line">    sch.sched_priority = 20;</div><div class="line">    if (pthread_setschedparam(t1.native_handle(), SCHED_FIFO, &amp;sch)) &#123;</div><div class="line">        std::cout &lt;&lt; "Failed to setschedparam: " &lt;&lt; std::strerror(errno) &lt;&lt; '\n';</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    t1.join(); t2.join();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>static unsigned int hardware_concurrency() noexcept; 返回并发数的参考</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span></div><div class="line">&#123;</div><div class="line">    <span class="comment">//注意这是个静态方法</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> n = <span class="built_in">std</span>::thread::hardware_concurrency();</div><div class="line">     <span class="comment">//结果和你的逻辑处理器processor个数保持一致, cat /proc/cpuinfo </span></div><div class="line">      <span class="comment">//每个processor 启动一个硬件线程</span></div><div class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; n &lt;&lt; <span class="string">" concurrent threads are supported.\n"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>void join(); 阻塞等待回收其他线程; 只有本线程 <code>joinable is false</code> , 即当前不在运行, 才可以回收其他线程, 否则出现自己等待回收自己, 那就是死锁了.</p>
</li>
<li><p>void detach(); 主要是设置分离的线程自己调用detach方法, 必须当前线程在运行, 即joinable才可以.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;chrono&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">independentThread</span><span class="params">()</span> </span></div><div class="line">&#123;</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Starting concurrent thread.\n"</span>;</div><div class="line">    <span class="built_in">std</span>::this_thread::sleep_for(<span class="built_in">std</span>::chrono::seconds(<span class="number">2</span>));</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Exiting concurrent thread.\n"</span>;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">threadCaller</span><span class="params">()</span> </span></div><div class="line">&#123;</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Starting thread caller.\n"</span>;</div><div class="line">    <span class="built_in">std</span>::<span class="function">thread <span class="title">t</span><span class="params">(independentThread)</span></span>;</div><div class="line">    t.detach();</div><div class="line">    <span class="built_in">std</span>::this_thread::sleep_for(<span class="built_in">std</span>::chrono::seconds(<span class="number">1</span>));</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Exiting thread caller.\n"</span>;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span></div><div class="line">&#123;</div><div class="line">    threadCaller();</div><div class="line">    <span class="built_in">std</span>::this_thread::sleep_for(<span class="built_in">std</span>::chrono::seconds(<span class="number">5</span>));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>void swap( thread&amp; other ) noexcept; 交换线程对象所绑定的具体线程</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;chrono&gt;</span></span></div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="built_in">std</span>::this_thread::sleep_for(<span class="built_in">std</span>::chrono::seconds(<span class="number">1</span>));</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">bar</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="built_in">std</span>::this_thread::sleep_for(<span class="built_in">std</span>::chrono::seconds(<span class="number">1</span>));</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="built_in">std</span>::<span class="function">thread <span class="title">t1</span><span class="params">(foo)</span></span>;</div><div class="line">    <span class="built_in">std</span>::<span class="function">thread <span class="title">t2</span><span class="params">(bar)</span></span>;</div><div class="line"> </div><div class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"thread 1 id: "</span> &lt;&lt; t1.get_id() &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"thread 2 id: "</span> &lt;&lt; t2.get_id() &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</div><div class="line"> </div><div class="line">    <span class="built_in">std</span>::swap(t1, t2);</div><div class="line"> </div><div class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"after std::swap(t1, t2):"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"thread 1 id: "</span> &lt;&lt; t1.get_id() &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"thread 2 id: "</span> &lt;&lt; t2.get_id() &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</div><div class="line"> </div><div class="line">    t1.swap(t2);</div><div class="line"> </div><div class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"after t1.swap(t2):"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"thread 1 id: "</span> &lt;&lt; t1.get_id() &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"thread 2 id: "</span> &lt;&lt; t2.get_id() &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</div><div class="line"> </div><div class="line">    t1.join();</div><div class="line">    t2.join();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/*运行结果*/</span></div><div class="line">thread <span class="number">1</span> id: <span class="number">1892</span></div><div class="line">thread <span class="number">2</span> id: <span class="number">2584</span></div><div class="line">after <span class="built_in">std</span>::swap(t1, t2):</div><div class="line">thread <span class="number">1</span> id: <span class="number">2584</span></div><div class="line">thread <span class="number">2</span> id: <span class="number">1892</span></div><div class="line">after t1.swap(t2):</div><div class="line">thread <span class="number">1</span> id: <span class="number">1892</span></div><div class="line">thread <span class="number">2</span> id: <span class="number">2584</span></div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="this-thread"><a href="#this-thread" class="headerlink" title="this_thread"></a>this_thread</h3><p>这个命名空间下, 主要说几个函数:</p>
<ul>
<li><p>yield : void yield() noexcept; 让出cpu, 让其他线程执行.<br>是否阻塞让出cpu和操作系统的实现有关, 也就是说这只是个建议. For example, a first-in-first-out realtime scheduler (SCHED_FIFO in Linux) would suspend the current thread and put it on the back of the queue of the same-priority threads that are ready to run (and if there are no other threads at the same priority, yield has no effect). 样例代码可以看下面:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;chrono&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></div><div class="line"> </div><div class="line"><span class="comment">// "busy sleep" while suggesting that other threads run </span></div><div class="line"><span class="comment">// for a small amount of time</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">little_sleep</span><span class="params">(<span class="built_in">std</span>::chrono::microseconds us)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">auto</span> start = <span class="built_in">std</span>::chrono::high_resolution_clock::now();</div><div class="line">    <span class="keyword">auto</span> end = start + us;</div><div class="line">    <span class="keyword">do</span> &#123;</div><div class="line">       <span class="comment">//使用的时候注意加上命名空间</span></div><div class="line">        <span class="built_in">std</span>::this_thread::yield();</div><div class="line">    &#125; <span class="keyword">while</span> (<span class="built_in">std</span>::chrono::high_resolution_clock::now() &lt; end);</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">auto</span> start = <span class="built_in">std</span>::chrono::high_resolution_clock::now();</div><div class="line"> </div><div class="line">    little_sleep(<span class="built_in">std</span>::chrono::microseconds(<span class="number">100</span>));</div><div class="line"> </div><div class="line">    <span class="keyword">auto</span> elapsed = <span class="built_in">std</span>::chrono::high_resolution_clock::now() - start;</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"waited for "</span></div><div class="line">              &lt;&lt; <span class="built_in">std</span>::chrono::duration_cast&lt;<span class="built_in">std</span>::chrono::microseconds&gt;(elapsed).count()</div><div class="line">              &lt;&lt; <span class="string">" microseconds\n"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>get_id : std::thread::id get_id() noexcept; 获取当前线程的id, 类型为 std::thread::id</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;chrono&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mutex&gt;</span></span></div><div class="line"> </div><div class="line"><span class="built_in">std</span>::mutex g_display_mutex;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="built_in">std</span>::thread::id this_id = <span class="built_in">std</span>::this_thread::get_id();</div><div class="line"> </div><div class="line">    g_display_mutex.lock();</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"thread "</span> &lt;&lt; this_id &lt;&lt; <span class="string">" sleeping...\n"</span>;</div><div class="line">    g_display_mutex.unlock();</div><div class="line"> </div><div class="line">    <span class="built_in">std</span>::this_thread::sleep_for(<span class="built_in">std</span>::chrono::seconds(<span class="number">1</span>));</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="built_in">std</span>::<span class="function">thread <span class="title">t1</span><span class="params">(foo)</span></span>;</div><div class="line">    <span class="built_in">std</span>::<span class="function">thread <span class="title">t2</span><span class="params">(foo)</span></span>;</div><div class="line"> </div><div class="line">    t1.join();</div><div class="line">    t2.join();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>sleep_for: 主动睡眠放弃cpu一定时间, 之后自动醒来.(由系统调度), 代码原型如下:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">template</span>&lt; <span class="keyword">class</span> Rep, <span class="keyword">class</span> Period &gt; <span class="comment">//Rep数字计数单位, Period时间单位</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">sleep_for</span><span class="params">( <span class="keyword">const</span> <span class="built_in">std</span>::chrono::duration&lt;Rep, Period&gt;&amp; sleep_duration )</span></span>;</div></pre></td></tr></table></figure>
<p>基本使用:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;chrono&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>::chrono_literals;</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Hello waiter"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">auto</span> start = <span class="built_in">std</span>::chrono::high_resolution_clock::now();</div><div class="line">    <span class="built_in">std</span>::this_thread::sleep_for(<span class="number">2</span>s);</div><div class="line">    <span class="keyword">auto</span> end = <span class="built_in">std</span>::chrono::high_resolution_clock::now();</div><div class="line">    <span class="comment">// 注意持续的时间可以使用std::chrono::duration并提供单位</span></div><div class="line">    <span class="built_in">std</span>::chrono::duration&lt;<span class="keyword">double</span>, <span class="built_in">std</span>::milli&gt; elapsed = end-start;</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Waited "</span> &lt;&lt; elapsed.count() &lt;&lt; <span class="string">" ms\n"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>sleep_until 睡眠到某个时间点</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">template</span>&lt; <span class="keyword">class</span> Clock, <span class="keyword">class</span> Duration &gt;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">sleep_until</span><span class="params">( <span class="keyword">const</span> <span class="built_in">std</span>::chrono::time_point&lt;Clock,Duration&gt;&amp; sleep_time )</span></span>;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>std::this_thread下的这几个函数还是经常用到的:</p>
<ul>
<li>yield</li>
<li>get_id</li>
<li>sleep_for</li>
<li>sleep_until</li>
</ul>
<hr>
<p>整理&amp;上传 ING.</p>
<h1 id="尾巴"><a href="#尾巴" class="headerlink" title="尾巴"></a>尾巴</h1><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ol>
<li><a href="">《C++并发编程实战》</a></li>
<li><a href="http://www.merlinblog.site/2017/06/21/boost.html" target="_blank" rel="external">boost总结</a></li>
<li><a href="http://www.boost.org/doc/libs/1_49_0/doc/html/thread.html" target="_blank" rel="external">boost线程库</a></li>
<li><a href="http://en.cppreference.com/w/cpp/thread" target="_blank" rel="external">cppreference</a></li>
</ol>
<hr>
<p>who is sponsoring the site? - i shall say merlin (<code>wizardmerlin945@gmail.com</code>)<br>欢迎发邮件给我(生活问题，请高抬贵手)</p>
	  
	</div>

	<div>
  	<center>
	<div class="pagination">

    
    
    <a href="/2017/06/30/try-stock-trading-system.html" type="button" class="btn btn-default"><i
                class="fa fa-arrow-circle-o-left"></i> Prev</a>
    

    <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
    
    <a href="/2017/06/24/three-major-tools-of-linux.html" type="button" class="btn btn-default ">Next<i
                class="fa fa-arrow-circle-o-right"></i></a>
    

    
</div>

    </center>
	</div>
	
	<!-- comment -->
	

	</div> <!-- col-md-9/col-md-12 -->
		
	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2017-06-29 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/codings/">codings<span>63</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/boost/">boost<span>7</span></a></li> <li><a href="/tags/cpp/">cpp<span>22</span></a></li> <li><a href="/tags/thread/">thread<span>7</span></a></li>
    </ul>
	</div>
		

	<!-- toc -->
	<div class="meta-widget">
	
	   <a data-toggle="collapse" data-target="#toc"><i class="fa fa-bars"></i></a>
	   <div id="toc" class="toc collapse in">
		   <span class="toc-title">Contents</span>
			<ol class="toc-article"><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#引子"><span class="toc-article-text">引子</span></a></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#正文"><span class="toc-article-text">正文</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#简介"><span class="toc-article-text">简介</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Threads库"><span class="toc-article-text">Threads库</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#thread类"><span class="toc-article-text">thread类</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#this-thread"><span class="toc-article-text">this_thread</span></a></li></ol></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#尾巴"><span class="toc-article-text">尾巴</span></a></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#参考资料"><span class="toc-article-text">参考资料</span></a></li></ol>
		</div>
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

	</div>
		

</div><!-- row -->



	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2017 MerlinYu
  
     
     <br> Theme by <a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind.386</a>.    
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



</body>
   </html>
