<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>rapid-json | Merlin&#39;s Blog</title>
  <meta name="author" content="MerlinYu">
  
  <meta name="description" content="总结rapid-json">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="rapid-json"/>
  <meta property="og:site_name" content="Merlin&#39;s Blog"/>

  
    <meta property="og:image" content="undefined"/>
  

  
  
    <link href="/favicon.png" rel="ico">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  



</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">Merlin&#39;s Blog</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="Subscribe me.">
			  <i class=""></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">
			<h1> rapid-json</h1>
		</div>
	



<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  
		 <div class="alert alert-success description">
			<i class="fa fa-info-circle"></i> 总结rapid-json
		 </div> <!-- alert -->
	  		

	  <p>国人自己开发的库, 全部以头文件的形式包含. 在知乎的<a href="https://www.zhihu.com/question/23654513" target="_blank" rel="external">评测</a>也是各种好评.<br>其他的解析工具, 玩玩就可以了, 实际项目中, 还是推荐用 <code>RapidJson</code>.</p>
<p>本文是关于 rapid-json 的简单讲解和介绍.</p>
<a id="more"></a>
<h1 id="引子"><a href="#引子" class="headerlink" title="引子"></a>引子</h1><p>发现每次都会有一大堆人去说XML和JSON的优缺点, 我觉得也是挺烦的, 下面一句话带过:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;</div><div class="line">&lt;country&gt;</div><div class="line">  &lt;name&gt;中国&lt;/name&gt;</div><div class="line">  &lt;province&gt;</div><div class="line">    &lt;name&gt;黑龙江&lt;/name&gt;</div><div class="line">    &lt;citys&gt;</div><div class="line">      &lt;city&gt;哈尔滨&lt;/city&gt;</div><div class="line">      &lt;city&gt;大庆&lt;/city&gt;</div><div class="line">    &lt;/citys&gt;  　　</div><div class="line">  &lt;/province&gt;</div><div class="line">  &lt;province&gt;</div><div class="line">    &lt;name&gt;广东&lt;/name&gt;</div><div class="line">    &lt;citys&gt;</div><div class="line">      &lt;city&gt;广州&lt;/city&gt;</div><div class="line">      &lt;city&gt;深圳&lt;/city&gt;</div><div class="line">      &lt;city&gt;珠海&lt;/city&gt;</div><div class="line">    &lt;/citys&gt; 　　</div><div class="line">  &lt;/province&gt;</div><div class="line">  &lt;province&gt;</div><div class="line">    &lt;name&gt;台湾&lt;/name&gt;</div><div class="line">    &lt;citys&gt;</div><div class="line">      　&lt;city&gt;台北&lt;/city&gt;</div><div class="line">      　&lt;city&gt;高雄&lt;/city&gt;</div><div class="line">    &lt;/citys&gt;　</div><div class="line">  &lt;/province&gt;</div><div class="line">  &lt;province&gt;</div><div class="line">    &lt;name&gt;新疆&lt;/name&gt;</div><div class="line">    &lt;citys&gt;</div><div class="line">      &lt;city&gt;乌鲁木齐&lt;/city&gt;</div><div class="line">    &lt;/citys&gt;</div><div class="line">  &lt;/province&gt;</div><div class="line">&lt;/country&gt;</div></pre></td></tr></table></figure></p>
<p>再看json<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">	name: &quot;中国&quot;,</div><div class="line">	provinces: </div><div class="line">        [</div><div class="line">	 &#123; name: &quot;黑龙江&quot;, citys: &#123; city: [&quot;哈尔滨&quot;, &quot;大庆&quot;]&#125; &#125;,</div><div class="line">	 &#123; name: &quot;广东&quot;, citys: &#123; city: [&quot;广州&quot;, &quot;深圳&quot;, &quot;珠海&quot;]&#125; &#125;,</div><div class="line">	 &#123; name: &quot;台湾&quot;, citys: &#123; city: [&quot;台北&quot;, &quot;高雄&quot;]&#125; &#125;,</div><div class="line">	 &#123; name: &quot;新疆&quot;, citys: &#123; city: [&quot;乌鲁木齐&quot;]&#125; &#125;</div><div class="line">	]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>XML的可读性稍微好一些, 但是冗余信息多, 体积大; 并且解析方便程度来说, JSON完胜.<br>(但是业界流行程度来说, XML业界广泛认同)</p>
<p>本文主要介绍RapidJson的使用以及一些心得, 如果你对它的源码也感兴趣的话, 可以参考该 <a href="http://miloyip.com/rapidjson/" target="_blank" rel="external">链接</a><br>(补充, 有人喜欢用 <a href="http://blog.csdn.net/hailong0715/article/details/51942736" target="_blank" rel="external">JsonCpp</a>, 不过还是推荐你用RapidJson吧)</p>
<p>(虽然有官方教程, 不过觉得那个教程也是非常啰嗦的)</p>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>rapidjson是腾讯的开源json解析框架，用c++实现。由于全部代码仅用header file实现，所以很容易集成到项目中。rapidjson的另一个特点是对json的标准符合程度是100%的(在开启了full precision选项的情况下).</p>
<p>最重要的: <code>RapidJSON is a JSON parser and generator for C++</code> .</p>
<p>总之, 业界也有好评, 个人觉得比 JsonCpp 好.</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>RapidJSON 是只有头文件的 C++ 库。只需把 include/rapidjson 目录复制至系统或项目的 include 目录中。<br>给出我的参考步骤:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ git clone https://github.com/miloyip/rapidjson.git</div><div class="line">$ cmake .</div><div class="line">$ sudo make install</div></pre></td></tr></table></figure></p>
<p>然后, 你的相关库就安装到了 <code>/usr/local/include/</code></p>
<h2 id="库文件"><a href="#库文件" class="headerlink" title="库文件"></a>库文件</h2><p>安装完了, 顺便可以扫一眼, 都有哪些库:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">$ tree -L 2 /usr/local/include/rapidjson</div><div class="line">/usr/local/include/rapidjson</div><div class="line">├── allocators.h</div><div class="line">├── document.h</div><div class="line">├── encodedstream.h</div><div class="line">├── encodings.h</div><div class="line">├── error</div><div class="line">│   ├── en.h</div><div class="line">│   └── error.h</div><div class="line">├── filereadstream.h</div><div class="line">├── filewritestream.h</div><div class="line">├── fwd.h</div><div class="line">├── internal</div><div class="line">│   ├── biginteger.h</div><div class="line">│   ├── diyfp.h</div><div class="line">│   ├── dtoa.h</div><div class="line">│   ├── ieee754.h</div><div class="line">│   ├── itoa.h</div><div class="line">│   ├── meta.h</div><div class="line">│   ├── pow10.h</div><div class="line">│   ├── regex.h</div><div class="line">│   ├── stack.h</div><div class="line">│   ├── strfunc.h</div><div class="line">│   ├── strtod.h</div><div class="line">│   └── swap.h</div><div class="line">├── istreamwrapper.h</div><div class="line">├── memorybuffer.h</div><div class="line">├── memorystream.h</div><div class="line">├── msinttypes</div><div class="line">│   ├── inttypes.h</div><div class="line">│   └── stdint.h</div><div class="line">├── ostreamwrapper.h</div><div class="line">├── pointer.h</div><div class="line">├── prettywriter.h</div><div class="line">├── rapidjson.h</div><div class="line">├── reader.h</div><div class="line">├── schema.h</div><div class="line">├── stream.h</div><div class="line">├── stringbuffer.h</div><div class="line">└── writer.h</div><div class="line"></div><div class="line">3 directories, 35 files</div></pre></td></tr></table></figure></p>
<h2 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h2><p>先来些简单的案例, 再说相关的API和机制.</p>
<p>此简单例子解析一个 JSON 字符串至一个 document (DOM), 对 DOM 作出简单修改, 最终把 DOM 转换(stringify) 至 JSON 字符串.<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// JSON simple example</span></div><div class="line"><span class="comment">// This example does not handle errors.</span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"rapidjson/document.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"rapidjson/writer.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"rapidjson/stringbuffer.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> rapidjson;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// 1. Parse a JSON string into DOM.</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* json = <span class="string">"&#123;\"project\":\"rapidjson\",\"stars\":10&#125;"</span>;</div><div class="line">    Document d;</div><div class="line">    d.Parse(json);</div><div class="line"></div><div class="line">    <span class="comment">// 2. Modify it by DOM.</span></div><div class="line">    Value&amp; s = d[<span class="string">"stars"</span>];</div><div class="line">    s.SetInt(s.GetInt() + <span class="number">1</span>);</div><div class="line"></div><div class="line">    <span class="comment">// 3. Stringify the DOM</span></div><div class="line">    StringBuffer buffer;</div><div class="line">    Writer&lt;StringBuffer&gt; writer(buffer);</div><div class="line">    d.Accept(writer);</div><div class="line"></div><div class="line">    <span class="comment">// Output &#123;"project":"rapidjson","stars":11&#125;</span></div><div class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; buffer.GetString() &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>注意此例子并没有处理潜在错误, 比如:<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 2. Modify it by DOM.   </span></div><div class="line">Value&amp; s = d[<span class="string">"stars"</span>];</div><div class="line"><span class="keyword">if</span>( s.IsInt() ) &#123;</div><div class="line">    s.SetInt(s.GetInt() + <span class="number">1</span>);  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>编译运行:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ g++ -g -Wall -O0 simpledom.cpp -o simpledom -I/usr/local/inlcude/</div><div class="line">$ ./simpledom</div><div class="line">&#123;&quot;project&quot;:&quot;rapidjson&quot;,&quot;stars&quot;:11&#125;</div></pre></td></tr></table></figure></p>
<p>可以简单的得出结论, 解析JSON是围绕 <code>rapidjson::Document</code>, <code>rapidjson::Value</code> 展开的, 关键性头文件:</p>
<ul>
<li>rapidjson/document.h</li>
<li>rapidjson/writer.h</li>
</ul>
<hr>
<p>再来一个实用一点儿的例子:<br>test.json<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;dictVersion&quot;: 1,  </div><div class="line">    &quot;content&quot;:  </div><div class="line">    [   </div><div class="line">        &#123;&quot;key&quot;: &quot;word1&quot;, &quot;value&quot;: &quot;单词1&quot;&#125; ,</div><div class="line">        &#123;&quot;key&quot;: &quot;word2&quot;, &quot;value&quot;: &quot;单词2&quot;&#125; ,</div><div class="line">        &#123;&quot;key&quot;: &quot;word3&quot;, &quot;value&quot;: &quot;单词3&quot;&#125; ,</div><div class="line">        &#123;&quot;key&quot;: &quot;word4&quot;, &quot;value&quot;: &quot;单词4&quot;&#125; ,</div><div class="line">        &#123;&quot;key&quot;: &quot;word5&quot;, &quot;value&quot;: &quot;单词5&quot;&#125; </div><div class="line">    ]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>对于这种格式化好的文件的读写, 可以采用流式读写处理:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// test.cpp</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"rapidjson/document.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"rapidjson/stringbuffer.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"rapidjson/writer.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fstream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cassert&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> psln(x) std::cout &lt;&lt; #x <span class="meta-string">" = "</span> &lt;&lt; (x) &lt;&lt; std::endl</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">testSimpleDoc</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">string</span>;</div><div class="line">  <span class="keyword">using</span> <span class="built_in">std</span>::ifstream;</div><div class="line"></div><div class="line">  <span class="comment">// read json content into string.</span></div><div class="line">  <span class="built_in">string</span>      stringFromStream;</div><div class="line">  ifstream    in;</div><div class="line">  in.open(<span class="string">"test.json"</span>, ifstream::in);</div><div class="line">  <span class="keyword">if</span> (!in.is_open())</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  <span class="built_in">string</span> line;</div><div class="line">  <span class="keyword">while</span> (getline(in, line)) &#123;</div><div class="line">    stringFromStream.append(line + <span class="string">"\n"</span>);</div><div class="line">  &#125;</div><div class="line">  in.close();</div><div class="line"></div><div class="line">  <span class="comment">// ---------------------------- read json --------------------</span></div><div class="line">  <span class="comment">// parse json from string.</span></div><div class="line">  <span class="keyword">using</span> rapidjson::Document;</div><div class="line">  Document doc;</div><div class="line">  doc.Parse(stringFromStream.c_str());</div><div class="line">  <span class="keyword">if</span> (doc.HasParseError()) &#123;</div><div class="line">    rapidjson::ParseErrorCode code = doc.GetParseError();</div><div class="line">    psln(code);</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// use values in parse result.</span></div><div class="line">  <span class="keyword">using</span> rapidjson::Value;</div><div class="line">  <span class="keyword">using</span> rapidjson::Type;</div><div class="line">  <span class="keyword">using</span> rapidjson::StringBuffer;</div><div class="line">  <span class="keyword">using</span> rapidjson::Writer;</div><div class="line">  </div><div class="line">  Value &amp; v = doc[<span class="string">"dictVersion"</span>];</div><div class="line">  <span class="keyword">if</span> (v.IsInt()) &#123;</div><div class="line">    psln(v.GetInt());</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  Value &amp; contents = doc[<span class="string">"content"</span>];</div><div class="line">  <span class="keyword">if</span> (contents.IsArray()) &#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; contents.Size(); ++i) &#123;</div><div class="line">      Value &amp; v = contents[i];</div><div class="line">      assert(v.IsObject());</div><div class="line">      <span class="keyword">if</span> (v.HasMember(<span class="string">"key"</span>) &amp;&amp; v[<span class="string">"key"</span>].IsString()) &#123;</div><div class="line">	psln(v[<span class="string">"key"</span>].GetString());</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (v.HasMember(<span class="string">"value"</span>) &amp;&amp; v[<span class="string">"value"</span>].IsString()) &#123;</div><div class="line">	psln(v[<span class="string">"value"</span>].GetString());</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// ---------------------------- write json --------------------</span></div><div class="line">  psln(<span class="string">"add a value into array"</span>);</div><div class="line"></div><div class="line">  <span class="function">Value <span class="title">item</span><span class="params">(Type::kObjectType)</span></span>;</div><div class="line">  item.AddMember(<span class="string">"key"</span>, <span class="string">"word5"</span>, doc.GetAllocator());</div><div class="line">  item.AddMember(<span class="string">"value"</span>, <span class="string">"单词5"</span>, doc.GetAllocator());</div><div class="line">  contents.PushBack(item, doc.GetAllocator());</div><div class="line"></div><div class="line">  <span class="comment">// convert dom to string.</span></div><div class="line">  StringBuffer buffer;      <span class="comment">// in rapidjson/stringbuffer.h</span></div><div class="line">  Writer&lt;StringBuffer&gt; writer(buffer); <span class="comment">// in rapidjson/writer.h</span></div><div class="line">  doc.Accept(writer);<span class="comment">// Accept() traverses the DOM and generates Handler events.</span></div><div class="line"></div><div class="line">  psln(buffer.GetString());</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">  testSimpleDoc();</div><div class="line">  <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>编译运行:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">$ g++ -g -Wall test.cpp -o test -I/usr/local/include</div><div class="line">$ ./test </div><div class="line">v.GetInt() = 1</div><div class="line">v[&quot;key&quot;].GetString() = word1</div><div class="line">v[&quot;value&quot;].GetString() = 单词1</div><div class="line">v[&quot;key&quot;].GetString() = word2</div><div class="line">v[&quot;value&quot;].GetString() = 单词2</div><div class="line">v[&quot;key&quot;].GetString() = word3</div><div class="line">v[&quot;value&quot;].GetString() = 单词3</div><div class="line">v[&quot;key&quot;].GetString() = word4</div><div class="line">v[&quot;value&quot;].GetString() = 单词4</div><div class="line">v[&quot;key&quot;].GetString() = word5</div><div class="line">v[&quot;value&quot;].GetString() = 单词5</div><div class="line">&quot;add a value into array&quot; = add a value into array</div><div class="line">buffer.GetString() = &#123;&quot;dictVersion&quot;:1,&quot;content&quot;:[&#123;&quot;key&quot;:&quot;word1&quot;,&quot;value&quot;:&quot;单词1&quot;&#125;,&#123;&quot;key&quot;:&quot;word2&quot;,&quot;value&quot;:&quot;单词2&quot;&#125;,&#123;&quot;key&quot;:&quot;word3&quot;,&quot;value&quot;:&quot;单词3&quot;&#125;,&#123;&quot;key&quot;:&quot;word4&quot;,&quot;value&quot;:&quot;单词4&quot;&#125;,&#123;&quot;key&quot;:&quot;word5&quot;,&quot;value&quot;:&quot;单词5&quot;&#125;,&#123;&quot;key&quot;:&quot;word5&quot;,&quot;value&quot;:&quot;单词5&quot;&#125;]&#125;</div></pre></td></tr></table></figure></p>
<p>从上面两个例子, 就可以看出, 只要你给document对象parse(const char*)一个C串, 那么它就会把解析的内容全部存储在document对象里; <code>Value &amp; v = doc[key];</code> 可以拿到单个对象或者Array(这里的array就像一个list或者数组), 结合Value进行读写, Value类含有 <code>HasMember()</code>, <code>AddMemeber()</code> 之类的方法, 以及和Document类一样重载了 <code>operator[]()</code>, 而<code>v[&quot;key&quot;].GetString()</code>,  <code>v.GetInt()</code> 则可以拿到具体的内容. 上面例子只给出了array如何添加成员, 其实document添加成员, 也是<code>document.AddMember(&quot;key buffer&quot;, &quot;value buffer-object&quot;, document.GetAllocator());</code> , 并且 document 可以是Object, 也可以是Array, 上面这些例子都是Object. </p>
<p>value[“key”]得到的类型还是Value类型, 当然也可以用v.IsObject()检验:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Document -&gt; Value</span></div><div class="line">Value &amp; v = doc[key];</div><div class="line">v.GetInt();</div><div class="line"></div><div class="line"><span class="comment">//对比: value.GetInt()</span></div><div class="line">v[<span class="string">"key"</span>].GetString()</div></pre></td></tr></table></figure>
<p>漂亮的输出到屏幕上(格式修正):<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"rapidjson/prettywriter.h"</span></span></div><div class="line"></div><div class="line"> StringBuffer sb;</div><div class="line"> PrettyWriter&lt;StringBuffer&gt; writer(sb);</div><div class="line"> document.Accept(writer);</div><div class="line"> <span class="built_in">puts</span>(sb.GetString());</div></pre></td></tr></table></figure></p>
<p>运行结果大致是:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">v.GetInt() = 1</div><div class="line">v[&quot;key&quot;].GetString() = word1</div><div class="line">v[&quot;value&quot;].GetString() = 单词1</div><div class="line">v[&quot;key&quot;].GetString() = word2</div><div class="line">v[&quot;value&quot;].GetString() = 单词2</div><div class="line">v[&quot;key&quot;].GetString() = word3</div><div class="line">v[&quot;value&quot;].GetString() = 单词3</div><div class="line">v[&quot;key&quot;].GetString() = word4</div><div class="line">v[&quot;value&quot;].GetString() = 单词4</div><div class="line">&quot;add a value into array&quot; = add a value into array</div><div class="line">buffer.GetString() = &#123;</div><div class="line">    &quot;dictVersion&quot;: 1,</div><div class="line">    &quot;content&quot;: [</div><div class="line">        &#123;</div><div class="line">            &quot;key&quot;: &quot;word1&quot;,</div><div class="line">            &quot;value&quot;: &quot;单词1&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;key&quot;: &quot;word2&quot;,</div><div class="line">            &quot;value&quot;: &quot;单词2&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;key&quot;: &quot;word3&quot;,</div><div class="line">            &quot;value&quot;: &quot;单词3&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;key&quot;: &quot;word4&quot;,</div><div class="line">            &quot;value&quot;: &quot;单词4&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;key&quot;: &quot;word5&quot;,</div><div class="line">            &quot;value&quot;: &quot;单词5&quot;</div><div class="line">        &#125;</div><div class="line">    ]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>之后如果你想写入文件, 那么就把 <code>sb.GetString()</code> 以文本格式写入文件即可; 或者借助其他的流(下面的例子从stdin和stdout作为流输入和输出):<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">#include "rapidjson/reader.h"</div><div class="line">#include "rapidjson/prettywriter.h"</div><div class="line">#include "rapidjson/filereadstream.h"</div><div class="line">#include "rapidjson/filewritestream.h"</div><div class="line">#include "rapidjson/error/en.h"</div><div class="line"></div><div class="line">using namespace rapidjson;</div><div class="line"></div><div class="line">int main(int, char*[]) &#123;</div><div class="line">    // Prepare reader and input stream.</div><div class="line">    Reader reader;</div><div class="line">    char readBuffer[65536];</div><div class="line">    /*</div><div class="line">     ifstream    in;</div><div class="line">     in.open("test.json", ifstream::in); </div><div class="line">    */</div><div class="line">    FileReadStream is(stdin, readBuffer, sizeof(readBuffer));</div><div class="line"></div><div class="line">    // Prepare writer and output stream.</div><div class="line">    char writeBuffer[65536];</div><div class="line">    FileWriteStream os(stdout, writeBuffer, sizeof(writeBuffer));</div><div class="line">    PrettyWriter&lt;FileWriteStream&gt; writer(os);</div><div class="line"></div><div class="line">    // JSON reader parse from the input stream and let writer generate the output.</div><div class="line">    if (!reader.Parse&lt;kParseValidateEncodingFlag&gt;(is, writer)) &#123;</div><div class="line">        fprintf(stderr, "\nError(%u): %s\n", </div><div class="line">	 static_cast&lt;unsigned&gt;(reader.GetErrorOffset()), </div><div class="line">         GetParseError_En(reader.GetParseErrorCode()));</div><div class="line">        return 1;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>总之, 先把流读到字符串, 之后写解析逻辑.</p>
<h2 id="深入"><a href="#深入" class="headerlink" title="深入"></a>深入</h2><p>其实说到这里, 使用上, 基本没有问题了.</p>
<p>进一步的深入, 我给的建议是: </p>
<ol>
<li>先读一下 <a href="http://rapidjson.org/zh-cn/md_doc_tutorial_8zh-cn.html" target="_blank" rel="external">官方教程</a>.</li>
<li>然后把源码下面的 example 下面所有的 demo 全部玩一遍.</li>
</ol>
<p>教程里面, 拷贝转移以及move()部分, 内存流&amp;文件流部分(包装流效率不高), DOM&amp;SAX部分都是仔细看的, 下面是我的部分笔记:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line">Value可以用作表示Object, Array, 甚至简单的string</div><div class="line">Value a(kArrayType);</div><div class="line">Value o(Type::kObjectType);</div><div class="line">Value s = &quot;str&quot;;</div><div class="line"></div><div class="line"></div><div class="line">如果Value直接写</div><div class="line">Value v; //NUll</div><div class="line">此时你并不知道它表示什么.</div><div class="line"></div><div class="line"></div><div class="line">下面这种形式存储的就是指针了(浅拷贝)</div><div class="line">Value s;</div><div class="line">s.SetString(&quot;rapidjson&quot;);    // 可包含空字符，长度在编译萁推导</div><div class="line">s = &quot;rapidjson&quot;;             // 上行的缩写</div><div class="line"></div><div class="line">直接赋值, 有时候为了安全, 需要做一下标记: `StringRef(cstr)`</div><div class="line">const char * cstr = getenv(&quot;USER&quot;);    //注意是 const char *</div><div class="line">size_t cstr_len = ...;                 // 如果有长度</div><div class="line"></div><div class="line">Value s;</div><div class="line">// s.SetString(cstr);                  // 这不能通过编译</div><div class="line">s.SetString(StringRef(cstr));          // 可以，假设它的生命周期安全，并且是以空字符结尾的</div><div class="line">s = StringRef(cstr);                   // 上行的缩写</div><div class="line">s.SetString(StringRef(cstr, cstr_len));// 更快，可处理空字符</div><div class="line">s = StringRef(cstr, cstr_len);         // 上行的缩写</div><div class="line"></div><div class="line"></div><div class="line">补充: 和value的直接赋值, AddMember(), PushBack() 都采用转移语义(没有分配内存)</div><div class="line"></div><div class="line">这是深拷贝, setString时提供了allocator, 并且指定了长度.</div><div class="line">//value.GetStringLength() 能获取UTF字符串中如果存在\u000即空字符的情况下的长度</div><div class="line">//比strlen()强大, 当然如果你不传入长度, 那就默认使用strlen()</div><div class="line">value.SetString(buffer, len, document.GetAllocator()); </div><div class="line"></div><div class="line"></div><div class="line">如果value之间, 想深复制, 那么有两种方式:</div><div class="line">1. 构造中带有allocator</div><div class="line">Document d;</div><div class="line">Document::AllocatorType&amp; a = d.GetAllocator();</div><div class="line">Value v1(&quot;foo&quot;);</div><div class="line">// Value v2(v1); // 不容许</div><div class="line">Value v2(v1, a); // 制造一个克隆</div><div class="line"></div><div class="line">2. 采用copyfrom</div><div class="line">Value v2;</div><div class="line">v2.CopyFrom(v1, a);</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">对于Value如果是 Object, 它的AddMemeber()比较标准的写法, 即采用的是重置的写法:</div><div class="line">//和Document一样的AddMember(), 注Object是有key, value的pair,并且key一定是字符串</div><div class="line">Value item(Type::kObjectType);</div><div class="line">item.AddMember(&quot;key&quot;, &quot;word5&quot;, doc.GetAllocator());</div><div class="line"></div><div class="line"></div><div class="line">Value类型是Array, 注意它的PushBack是移动语义就可以了(即使带了allocator), </div><div class="line">当然这是针对非基本类型的数据(String, Object), </div><div class="line">即Push进去的元素可以是string类型的value, 或者Object类型的value.</div><div class="line"></div><div class="line">push进去的是 string类型或者Object类型也存在临时变量无法赋值给非const引用的, </div><div class="line">移动语义问题, 可以类似解决方法: move()返回一个非const引用</div><div class="line">// 就地 Value 参数</div><div class="line">contact.PushBack(Value(&quot;copy&quot;, document.GetAllocator()).Move(), // copy string</div><div class="line">                 document.GetAllocator());</div><div class="line">// 显式 Value 参数</div><div class="line">Value val(&quot;key&quot;, document.GetAllocator()); // copy string</div><div class="line">contact.PushBack(val, document.GetAllocator());</div></pre></td></tr></table></figure>
<p>这个时候(把那个几个example玩熟), 对这个库已经很熟悉了.<br>再深入, 就结合他的<a href="rapidjson.org">官网</a>以及源码慢慢琢磨吧.</p>
<hr>
<h1 id="尾巴"><a href="#尾巴" class="headerlink" title="尾巴"></a>尾巴</h1><p>没太多可说的, 写多了就熟悉了.</p>
<hr>
<p>who is sponsoring the site? - i shall say merlin (<code>wizardmerlin945@gmail.com</code>)<br>欢迎发邮件给我(生活问题，请高抬贵手)</p>
	  
	</div>

	<div>
  	<center>
	<div class="pagination">

    
    
    <a href="/2017/08/22/jni.html" type="button" class="btn btn-default"><i
                class="fa fa-arrow-circle-o-left"></i> Prev</a>
    

    <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
    
    <a href="/2017/08/22/rapid-xml.html" type="button" class="btn btn-default ">Next<i
                class="fa fa-arrow-circle-o-right"></i></a>
    

    
</div>

    </center>
	</div>
	
	<!-- comment -->
	

	</div> <!-- col-md-9/col-md-12 -->
		
	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2017-08-22 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/codings/">codings<span>62</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/cpp/">cpp<span>21</span></a></li>
    </ul>
	</div>
		

	<!-- toc -->
	<div class="meta-widget">
	
	   <a data-toggle="collapse" data-target="#toc"><i class="fa fa-bars"></i></a>
	   <div id="toc" class="toc collapse in">
		   <span class="toc-title">Contents</span>
			<ol class="toc-article"><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#引子"><span class="toc-article-text">引子</span></a></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#正文"><span class="toc-article-text">正文</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#简介"><span class="toc-article-text">简介</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#安装"><span class="toc-article-text">安装</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#库文件"><span class="toc-article-text">库文件</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#案例"><span class="toc-article-text">案例</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#深入"><span class="toc-article-text">深入</span></a></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#尾巴"><span class="toc-article-text">尾巴</span></a></li></ol>
		</div>
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

	</div>
		

</div><!-- row -->



	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2017 MerlinYu
  
     
     <br> Theme by <a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind.386</a>.    
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



</body>
   </html>
